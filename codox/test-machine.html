<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>The Test Machine</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Jackdaw</span> <span class="project-version">0.6.0</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1  current"><a href="test-machine.html"><div class="inner"><span>The Test Machine</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jackdaw</span></div></div></li><li class="depth-2 branch"><a href="jackdaw.admin.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>admin</span></div></a></li><li class="depth-2"><a href="jackdaw.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.client.log.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>log</span></div></a></li><li class="depth-3"><a href="jackdaw.client.partitioning.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>partitioning</span></div></a></li><li class="depth-2 branch"><a href="jackdaw.data.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>data</span></div></a></li><li class="depth-2"><a href="jackdaw.serdes.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>serdes</span></div></a></li><li class="depth-3"><a href="jackdaw.serdes.avro.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>avro</span></div></a></li><li class="depth-4 branch"><a href="jackdaw.serdes.avro.confluent.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>confluent</span></div></a></li><li class="depth-4"><a href="jackdaw.serdes.avro.schema-registry.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>schema-registry</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.serdes.edn.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>edn</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.serdes.fn.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fn</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.serdes.fn-impl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fn-impl</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.serdes.json.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>json</span></div></a></li><li class="depth-3"><a href="jackdaw.serdes.resolver.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>resolver</span></div></a></li><li class="depth-2 branch"><a href="jackdaw.specs.html"><div class="inner"><span class="tree" style="top: -269px;"><span class="top" style="height: 278px;"></span><span class="bottom"></span></span><span>specs</span></div></a></li><li class="depth-2"><a href="jackdaw.streams.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>streams</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.streams.configurable.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>configurable</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.streams.configured.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>configured</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.streams.extras.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>extras</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.streams.interop.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interop</span></div></a></li><li class="depth-3"><a href="jackdaw.streams.lambdas.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lambdas</span></div></a></li><li class="depth-4"><a href="jackdaw.streams.lambdas.specs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>specs</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.streams.mock.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>mock</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.streams.protocols.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>protocols</span></div></a></li><li class="depth-3"><a href="jackdaw.streams.specs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>specs</span></div></a></li><li class="depth-2"><a href="jackdaw.test.html"><div class="inner"><span class="tree" style="top: -300px;"><span class="top" style="height: 309px;"></span><span class="bottom"></span></span><span>test</span></div></a></li><li class="depth-3"><a href="jackdaw.test.commands.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>commands</span></div></a></li><li class="depth-4 branch"><a href="jackdaw.test.commands.base.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>base</span></div></a></li><li class="depth-4 branch"><a href="jackdaw.test.commands.watch.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>watch</span></div></a></li><li class="depth-4"><a href="jackdaw.test.commands.write.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>write</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.test.fixtures.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>fixtures</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.test.journal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>journal</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.test.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3 branch"><a href="jackdaw.test.serde.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>serde</span></div></a></li><li class="depth-3"><a href="jackdaw.test.transports.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>transports</span></div></a></li><li class="depth-4 branch"><a href="jackdaw.test.transports.identity.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>identity</span></div></a></li><li class="depth-4 branch"><a href="jackdaw.test.transports.kafka.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>kafka</span></div></a></li><li class="depth-4 branch"><a href="jackdaw.test.transports.mock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mock</span></div></a></li><li class="depth-4"><a href="jackdaw.test.transports.rest-proxy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>rest-proxy</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#the-test-machine" name="the-test-machine"></a>The Test Machine</h1>
<h2><a href="#rationale" name="rationale"></a>Rationale</h2>
<p>The test machine is what we came up with in an attempt to make it easier to write more reliable integration tests. By handling reads and writes in a background thread and making them available in a Clojure ref, the test author is relieved of the requirement to manually <code>send!</code> and <code>recv</code> messages from kafka. The initial aim was to simply ‘fire’ events at the system and then observe the outputs that are (or are not) collected by the reader. In general, the aims are to allow the creation of blackbox integration tests which are:</p>
<ul>
  <li>Generative, to avoid manual creation and alteration of test cases (or we will not write them, and will eventually abandon them)</li>
  <li>Reliable, so we trust the results (or we will ignore them)</li>
  <li>Fast, so we get results quickly (or we will not run them)</li>
</ul>
<p>The test machine also aims to be agnostic to the system it is testing, other than that it should get input/output primarily from Kafka.</p>
<h3><a href="#construction" name="construction"></a>Construction</h3>
<p>The examples below, demonstrate how to create a test machine for executing a sequence of “commands”. The “local-machine” will execute the commands against a local kafka cluster with all services running on their default ports. The “remote-machine” in contrast executes commands over HTTP using the configured rest-proxy. This can be useful in scenarios where you don’t have direct access to these services in a shared environment like uat/staging.</p>
<pre><code class="clojure">(ns my.app-test
  (:require
    [my.app :as app]
    [jackdaw.test :as j.t]))

(def local-kafka-config
  {"bootstrap.servers" "localhost:9092"
   "group.id" "my-app"})

(def topic-config
  {:foo {:topic-name "foo"
         :key-serde (string-serde)
         :value-serde (json-serde)}
   :bar {:topic-name "foo"
         :key-serde (string-serde)
         :value-serde (edn-serde)}})

(defn local-machine []
  (let [t (trns/transport {:type :kafka
                           :config local-kafka-config
                           :topics topic-config})]
    (test-machine {:transport t})))
    
(def remote-machine []
  (let [t (trns/transport {:type :confluent-rest-proxy
                           :config remote-kafka-config
                           :topics topic-config})]
   (test-machine {:transport t})))
</code></pre>
<h3><a href="#serialization-deserialization" name="serialization-deserialization"></a>Serialization/Deserialization</h3>
<p>The <code>topic-config</code> referenced in the snippet above is a mapping from topic-ids to serialization/deserialization configurations. This means that tests can read/write using the same serializers/deserializers used by your applications. So for example, on encountering a command like</p>
<pre><code class="clojure">[:write! :foo {:id 1, :msg "hello"}]
</code></pre>
<p>the test-machine will lookup <code>:foo</code> in the topic-config to get the <code>:key-serde</code> and <code>:value-serde</code> which it will then use when writing the message. Similarly, all topics listed in the topic-config are read using the corresponding deserializer.</p>
<h3><a href="#lifecycle" name="lifecycle"></a>Lifecycle</h3>
<p>The test-machine implements the <code>Closeable</code> protocol so be sure to use it in conjunction with <code>with-open</code> to ensure that associated resources are shut down cleanly when you are finished with a machine.</p>
<pre><code class="clojure">(deftest test-my-app
  (with-open [machine (local-machine))]
    (let [result (run-test machine test-commands)]
      (is (all-ok? result))))
</code></pre>
<h3><a href="#test-commands" name="test-commands"></a>Test Commands</h3>
<p>Each test-command is a vector with the first item being a keyword representing the type of operation this command represents, and subsequent items being command specific arguments. Currently the following commands are the supported.</p>
<pre><code class="clojure">  :write!   [topic-id msg opts]  Writes to the 
  :watch    [f opts]             Blocks until `(f @journal)` returns truthy
  :stop     []                   Stops processing commands. All subsequent commands
                                 are ignored
  :sleep    [sleep-ms]           Sleeps for `sleep-ms` milliseconds
  :println  [args]               Prints the supplied args to stdout
  :pprint   [args]               Pretty prints the supplied args to stdout
  :do       [f]                  Execute arbitrary function
</code></pre>
<h3><a href="#test-results" name="test-results"></a>Test Results</h3>
<p>The return value from <code>run-test</code> is a map with just two keys</p>
<pre><code class="clojure">:results   A sequence of execution results. One for each command attempted
:journal   A snapshot of all kafka output read by the test consumer
</code></pre>
<p>The journal contains all output written to the topics configured when creating the test-machine (including any input messages). Each key in the journal represents one topic. The value is a vector of messages observed on the topic in the order that they were observed.</p>
<h3><a href="#fixtures" name="fixtures"></a>Fixtures</h3>
<p>A selection of fixtures are provided to help setting up required topics and to start the applications, and external systems under test. For more details see the functions in the jackdaw.test.fixtures namespace.</p>
<h3><a href="#wrapping-up" name="wrapping-up"></a>Wrapping up</h3>
<p>You make find it helpful to write a function to tie it all together and invoke your test function <code>f</code> with a machine after performing any setup required. Since this typically involves some knowledge of the system under test, it’s likely better that you write this macro yourself so that you can tailor it to your own requirements.</p>
<pre><code class="clojure">(defn with-test-machine [f {:keys [transport}]}]
  (fix/with-fixtures [(fix/topic-fixture kafka-config input-topics)
                      (fix/topic-fixture kafka-config output-topics)
                      (fix/service-ready {:http-url "http://localhost:8082"
                                          :http-timeout 5000})]
    (with-open [machine (test-machine {:transport transport})]
      (f machine))))
</code></pre></div></div></div></body></html>
